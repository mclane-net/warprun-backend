# .gitlab-ci.yml
# WarpRun Dynamic Pipeline Router

workflow:
  name: "WarpRun: $WARPRUN_PIPELINE_NAME"
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule" && $WARPRUN_PIPELINE_NAME
    - when: never

# Validate pipeline and set child config path
validate-pipeline:
  script:
    - echo "Requested pipeline - $WARPRUN_PIPELINE_NAME"
    - echo "Correlation ID - $WARPRUN_CORRELATION_ID"
    - |
      if [ -z "$WARPRUN_PIPELINE_NAME" ]; then
        echo "PIPELINE_VALID=false" >> pipeline.env
        echo "PIPELINE_ERROR=WARPRUN_PIPELINE_NAME variable is not set" >> pipeline.env
      elif [ ! -f "pipelines/${WARPRUN_PIPELINE_NAME}.yml" ]; then
        echo "PIPELINE_VALID=false" >> pipeline.env
        echo "PIPELINE_ERROR=Pipeline file not found: pipelines/${WARPRUN_PIPELINE_NAME}.yml" >> pipeline.env
        ls -la pipelines/ 2>/dev/null || echo "No pipelines folder"
      else
        echo "PIPELINE_VALID=true" >> pipeline.env
        echo "CHILD_PIPELINE_FILE=pipelines/${WARPRUN_PIPELINE_NAME}.yml" >> pipeline.env
        echo "Pipeline file found"
      fi
    - cat pipeline.env
  artifacts:
    reports:
      dotenv: pipeline.env

# Trigger the child pipeline
execute-pipeline:
  needs: [validate-pipeline]
  trigger:
    include:
      - local: $CHILD_PIPELINE_FILE
    strategy: depend
    forward:
      pipeline_variables: true
  rules:
    - if: $PIPELINE_VALID == "true"

# Fallback when validation fails
pipeline-error:
  needs: [validate-pipeline]
  script:
    - echo "=========================================="
    - echo "ERROR - $PIPELINE_ERROR"
    - echo "=========================================="
    - echo "Available pipelines:"
    - ls -1 pipelines/*.yml 2>/dev/null | sed 's|pipelines/||; s|\.yml||' || echo "(none)"
    - exit 1
  rules:
    - if: $PIPELINE_VALID == "false"