# .gitlab-ci.yml
# WarpRun Dynamic Pipeline Router v2

workflow:
  name: "WarpRun $WARPRUN_PIPELINE_NAME"
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "web"
    - when: never

stages:
  - validate
  - execute
  - feedback

# ── Validate pipeline file exists ─────────────────────────────────────────────
validate-pipeline:
  stage: validate
  script:
    - echo "=== WarpRun Pipeline Router ==="
    - echo "Pipeline      : $WARPRUN_PIPELINE_NAME"
    - echo "Request ID    : $WARPRUN_REQUEST_ID"
    - echo "Correlation ID: $WARPRUN_CORRELATION_ID"
    - |
      if [ -z "$WARPRUN_PIPELINE_NAME" ]; then
        echo "ERROR: WARPRUN_PIPELINE_NAME is not set"
        exit 1
      fi
    - |
      if [ ! -f "pipelines/${WARPRUN_PIPELINE_NAME}.yml" ]; then
        echo "ERROR: Pipeline file 'pipelines/${WARPRUN_PIPELINE_NAME}.yml' not found"
        echo "Available pipelines:"
        ls -1 pipelines/*.yml 2>/dev/null || echo "  (none)"
        exit 1
      fi
    - echo "OK: Pipeline file found"
  rules:
    - if: $WARPRUN_PIPELINE_NAME

# ── Generate child pipeline path (dotenv artifact) ────────────────────────────
generate-child-config:
  stage: validate
  needs: [validate-pipeline]
  script:
    - echo "CHILD_PIPELINE_FILE=pipelines/${WARPRUN_PIPELINE_NAME}.yml" > pipeline.env
    - echo "Generated config:"
    - cat pipeline.env
  artifacts:
    reports:
      dotenv: pipeline.env
  rules:
    - if: $WARPRUN_PIPELINE_NAME

# ── Execute child pipeline ────────────────────────────────────────────────────
# strategy: depend    → parent waits for child, inherits child exit status
# pipeline_variables  → forwards ALL trigger variables (WARPRUN_*, region, vm_name, etc.)
# yaml_variables      → forwards Group/Project CI/CD variables (KEYCLOAK_SECRET, etc.)
execute-pipeline:
  stage: execute
  needs: [generate-child-config]
  trigger:
    include:
      - local: $CHILD_PIPELINE_FILE
    strategy: depend
    forward:
      pipeline_variables: true
      yaml_variables: true
  rules:
    - if: $WARPRUN_PIPELINE_NAME

# ── Send result back to WarpRun Frontend ──────────────────────────────────────
# when: always   → runs even if execute-pipeline failed or was cancelled
# optional: true → runs even if execute-pipeline was skipped
# Uses CI_JOB_TOKEN + GitLab API to resolve actual execute-pipeline status,
# because GitLab does not expose upstream job status as a CI variable.
notify-warprun:
  stage: feedback
  image: alpine:3.19
  needs:
    - job: execute-pipeline
      optional: true
  when: always
  before_script:
    - apk add --no-cache curl bash jq
    - chmod +x scripts/warprun-feedback.sh
  script:
    - |
      echo "=== WarpRun Feedback Stage ==="
      echo "Resolving execute-pipeline status via GitLab API..."

      JOBS_JSON=$(curl --silent --fail \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs?per_page=50")

      EXECUTE_STATUS=$(echo "$JOBS_JSON" \
        | jq -r '[.[] | select(.name == "execute-pipeline")] | sort_by(.id) | last | .status // "failed"')

      echo "execute-pipeline status: $EXECUTE_STATUS"

      case "$EXECUTE_STATUS" in
        success)            WARPRUN_PIPELINE_STATUS="success" ;;
        failed)             WARPRUN_PIPELINE_STATUS="failed" ;;
        canceled|cancelled) WARPRUN_PIPELINE_STATUS="cancelled" ;;
        skipped)            WARPRUN_PIPELINE_STATUS="cancelled" ;;
        *)                  WARPRUN_PIPELINE_STATUS="failed" ;;
      esac

      echo "Mapped WarpRun status: $WARPRUN_PIPELINE_STATUS"
      export WARPRUN_PIPELINE_STATUS
    - bash scripts/warprun-feedback.sh
  rules:
    - if: $WARPRUN_PIPELINE_NAME && $WARPRUN_REQUEST_ID

# ── Fallback: no pipeline name provided ───────────────────────────────────────
no-pipeline-specified:
  stage: validate
  script:
    - echo "No WARPRUN_PIPELINE_NAME provided."
    - echo "This pipeline is triggered by WarpRun only."
    - ls -la pipelines/ || echo "(no pipelines folder)"
    - exit 1
  rules:
    - if: $WARPRUN_PIPELINE_NAME == null
