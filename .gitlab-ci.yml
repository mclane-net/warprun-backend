# .gitlab-ci.yml
# WarpRun Dynamic Pipeline Router

workflow:
  name: "WarpRun $WARPRUN_PIPELINE_NAME"  
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"  # API/trigger token (WarpRun)
    - if: $CI_PIPELINE_SOURCE == "web"      # Manual from GitLab UI
    - when: never

stages:
  - validate
  - execute

# Validate that the requested pipeline exists
validate-pipeline:
  stage: validate
  script:
    - echo "Requested pipeline - $WARPRUN_PIPELINE_NAME"
    - echo "Correlation ID - $WARPRUN_CORRELATION_ID"
    - if [ -z "$WARPRUN_PIPELINE_NAME" ]; then echo "ERROR - WARPRUN_PIPELINE_NAME variable is not set"; exit 1; fi
    - if [ ! -f "pipelines/${WARPRUN_PIPELINE_NAME}.yml" ]; then echo "ERROR - Pipeline file not found"; ls -la pipelines/; exit 1; fi
    - echo "Pipeline file found. Proceeding..."
  rules:
    - if: $WARPRUN_PIPELINE_NAME
  artifacts:
    reports:
      dotenv: pipeline.env

# Generate the pipeline path for child trigger
generate-child-config:
  stage: validate
  needs: [validate-pipeline]
  script:
    - echo "CHILD_PIPELINE_FILE=pipelines/${WARPRUN_PIPELINE_NAME}.yml" >> pipeline.env
    - cat pipeline.env
  artifacts:
    reports:
      dotenv: pipeline.env
  rules:
    - if: $WARPRUN_PIPELINE_NAME

# Trigger the child pipeline with explicit include path
execute-pipeline:
  stage: execute
  needs: [generate-child-config]
  trigger:
    include:
      - local: $CHILD_PIPELINE_FILE
    strategy: depend
    forward:
      pipeline_variables: true
  rules:
    - if: $WARPRUN_PIPELINE_NAME

# Fallback when no pipeline name is provided
no-pipeline-specified:
  stage: validate
  script:
    - echo "No WARPRUN_PIPELINE_NAME provided."
    - echo "This pipeline is designed to be triggered by WarpRun."
    - ls -la pipelines/ || echo "No pipelines folder found"
    - exit 1
  rules:
    - if: $WARPRUN_PIPELINE_NAME == null